#!/bin/sh
#
# PROVIDE: cmonit
# REQUIRE: LOGIN DAEMON NETWORKING
# KEYWORD: shutdown
#
# Add the following lines to /etc/rc.conf to enable cmonit:
#
# cmonit_enable (bool):         Set to "NO" by default.
#                               Set it to "YES" to enable cmonit.
# cmonit_user (string):         Set user to run cmonit.
#                               Default is "root".
# cmonit_config (string):       Configuration file path (optional).
#                               If set, uses config file instead of individual flags.
#                               Example: "/etc/cmonit/cmonit.conf"
#                               Default is empty (use individual flags).
# cmonit_flags (string):        Additional command-line flags.
#                               Default is empty.
#                               Example: "-debug -listen 0.0.0.0:3000"
#
# Legacy individual flag variables (used when cmonit_config is not set):
# cmonit_pidfile (string):      PID file path (default: "/var/run/cmonit/cmonit.pid")
# cmonit_db (string):           Database path (default: "/var/run/cmonit/cmonit.db")
#
# For all other settings, use either cmonit_config or cmonit_flags.

. /etc/rc.subr

name=cmonit
rcvar=cmonit_enable

load_rc_config $name

: ${cmonit_enable:="NO"}
: ${cmonit_user:="root"}
: ${cmonit_config:=""}
: ${cmonit_flags:=""}
: ${cmonit_pidfile:="/var/run/cmonit/cmonit.pid"}
: ${cmonit_db:="/var/run/cmonit/cmonit.db"}

pidfile="${cmonit_pidfile}"
command="/usr/local/bin/${name}"

# Build command arguments
if [ -n "${cmonit_config}" ]; then
    # Config file mode: use -config flag + any additional flags
    command_args="-config ${cmonit_config} -pidfile ${cmonit_pidfile} -db ${cmonit_db} ${cmonit_flags}"
else
    # CLI-only mode: use -pidfile and -db, let user set everything else via cmonit_flags
    # For backward compatibility, you can still set individual flags in cmonit_flags
    command_args="-pidfile ${cmonit_pidfile} -db ${cmonit_db} ${cmonit_flags}"
fi

start_precmd="${name}_prestart"

cmonit_prestart()
{
    # Create runtime directory (/var/run/cmonit) if it doesn't exist
    # This directory typically holds both the database and PID file
    runtime_dir="/var/run/cmonit"
    if [ ! -d "${runtime_dir}" ]; then
        mkdir -p "${runtime_dir}"
        chown ${cmonit_user} "${runtime_dir}"
        chmod 755 "${runtime_dir}"
    fi

    # Create database directory if it's different from runtime dir
    db_dir=$(dirname "${cmonit_db}")
    if [ "${db_dir}" != "${runtime_dir}" ] && [ ! -d "${db_dir}" ]; then
        mkdir -p "${db_dir}"
        chown ${cmonit_user} "${db_dir}"
    fi

    # Ensure database file is writable by cmonit_user
    if [ -f "${cmonit_db}" ]; then
        chown ${cmonit_user} "${cmonit_db}"
    fi

    # Create PID file directory if needed
    pid_dir=$(dirname "${cmonit_pidfile}")
    if [ ! -d "${pid_dir}" ]; then
        mkdir -p "${pid_dir}"
        chmod 755 "${pid_dir}"
    fi
}

run_rc_command "$1"
