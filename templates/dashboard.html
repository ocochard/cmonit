<!DOCTYPE html>
<html>
<head>
    <title>cmonit Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <meta http-equiv="refresh" content="300">
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <!-- Breadcrumb Navigation -->
        <nav class="text-sm text-gray-500 mb-4">
            <a href="/" class="hover:text-gray-700 hover:underline">Status Overview</a>
            {{range $host := .Hosts}}
            <span class="mx-2">/</span>
            <span class="text-gray-900">{{$host.Hostname}}</span>
            {{end}}
        </nav>

        <h1 class="text-4xl font-bold text-gray-800 mb-4">Host Details</h1>
        <p class="text-gray-600 mb-8">Last updated: {{.LastUpdate.Format "2006-01-02 15:04:05"}}</p>

        {{if .Hosts}}
            {{range $host := .Hosts}}
            <div class="bg-white rounded-lg shadow-md mb-6">
                <div class="bg-blue-600 text-white px-6 py-4 rounded-t-lg">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h2 class="text-2xl font-semibold">{{$host.Hostname}}</h2>
                            <p class="text-sm opacity-90">Monit {{$host.Version}}</p>
                        </div>
                        <div>
                            {{if $host.IsStale}}
                            <span class="bg-red-500 px-3 py-1 rounded-full text-sm font-semibold">STALE</span>
                            {{else}}
                            <span class="bg-green-500 px-3 py-1 rounded-full text-sm font-semibold">ACTIVE</span>
                            {{end}}
                        </div>
                    </div>

                    <!-- Platform Information -->
                    {{if $host.OSName}}
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4 pt-4 border-t border-blue-500">
                        <div>
                            <div class="text-xs opacity-75 uppercase">Platform</div>
                            <div class="text-sm font-semibold">{{$host.OSName}} {{$host.OSRelease}}</div>
                            <div class="text-xs opacity-90">{{$host.Machine}}</div>
                        </div>
                        {{if gt $host.CPUCount 0}}
                        <div>
                            <div class="text-xs opacity-75 uppercase">CPUs</div>
                            <div class="text-lg font-bold">{{$host.CPUCount}}</div>
                            <div class="text-xs opacity-90">cores</div>
                        </div>
                        {{end}}
                        {{if gt $host.TotalMemory 0}}
                        <div>
                            <div class="text-xs opacity-75 uppercase">Memory</div>
                            <div class="text-lg font-bold">{{printf "%.1f" (divf $host.TotalMemory 1048576.0)}} GB</div>
                            {{if gt $host.TotalSwap 0}}
                            <div class="text-xs opacity-90">{{printf "%.1f" (divf $host.TotalSwap 1048576.0)}} GB swap</div>
                            {{end}}
                        </div>
                        {{end}}
                        {{if $host.SystemUptime}}
                        <div>
                            <div class="text-xs opacity-75 uppercase">Uptime</div>
                            <div class="text-sm font-semibold">{{formatDuration $host.SystemUptime}}</div>
                            {{if $host.Boottime}}
                            <div class="text-xs opacity-90">since {{formatTimestamp $host.Boottime}}</div>
                            {{end}}
                        </div>
                        {{end}}
                    </div>
                    {{end}}
                </div>

                <div class="px-6 py-4">
                    {{if $host.Services}}
                    <table class="min-w-full">
                        <thead>
                            <tr class="border-b-2">
                                <th class="text-left py-2 px-4">Service</th>
                                <th class="text-left py-2 px-4">Type</th>
                                <th class="text-left py-2 px-4">Status</th>
                                <th class="text-left py-2 px-4">Monitor</th>
                                <th class="text-right py-2 px-4">PID</th>
                                <th class="text-right py-2 px-4">CPU</th>
                                <th class="text-right py-2 px-4">Memory</th>
                                <th class="text-left py-2 px-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{range $service := $host.Services}}
                            <tr class="border-b hover:bg-gray-50">
                                <td class="py-2 px-4 font-medium">{{$service.Name}}</td>
                                <td class="py-2 px-4 text-sm text-gray-600">{{$service.TypeName}}</td>
                                <td class="py-2 px-4">
                                    <span class="px-2 py-1 rounded text-xs {{if eq $service.Status 0}}bg-green-500{{else if eq $service.Status 1}}bg-yellow-500{{else}}bg-red-500{{end}} text-white">
                                        {{$service.StatusName}}
                                    </span>
                                </td>
                                <td class="py-2 px-4 text-sm">
                                    {{if eq $service.Monitor 1}}
                                    <span class="text-green-600">●</span> Yes
                                    {{else}}
                                    <span class="text-gray-400">○</span> No
                                    {{end}}
                                </td>
                                <td class="py-2 px-4 text-right text-sm font-mono">
                                    {{if $service.PID}}{{$service.PID}}{{else}}<span class="text-gray-400">-</span>{{end}}
                                </td>
                                <td class="py-2 px-4 text-right text-sm">
                                    {{if $service.CPUPercent}}
                                    <span class="{{if gt (deref $service.CPUPercent) 50.0}}text-red-600 font-semibold{{else if gt (deref $service.CPUPercent) 20.0}}text-yellow-600{{else}}text-gray-700{{end}}">
                                        {{printf "%.1f" (deref $service.CPUPercent)}}%
                                    </span>
                                    {{else}}<span class="text-gray-400">-</span>{{end}}
                                </td>
                                <td class="py-2 px-4 text-right text-sm">
                                    {{if $service.MemoryPercent}}
                                    <span class="{{if gt (deref $service.MemoryPercent) 50.0}}text-red-600 font-semibold{{else if gt (deref $service.MemoryPercent) 20.0}}text-yellow-600{{else}}text-gray-700{{end}}">
                                        {{printf "%.1f" (deref $service.MemoryPercent)}}%
                                    </span>
                                    {{if $service.MemoryKB}}
                                    <span class="text-xs text-gray-500 block">{{printf "%.0f" (divf $service.MemoryKB 1024.0)}} MB</span>
                                    {{end}}
                                    {{else}}<span class="text-gray-400">-</span>{{end}}
                                </td>
                                <td class="py-2 px-4">
                                    <div class="flex gap-1">
                                        {{if eq $service.Type 3}}
                                            <button onclick="executeAction('{{$host.ID}}', '{{$service.Name}}', 'start')"
                                                class="px-2 py-1 bg-green-500 hover:bg-green-600 text-white text-xs rounded" title="Start service">
                                                ▶
                                            </button>
                                            <button onclick="executeAction('{{$host.ID}}', '{{$service.Name}}', 'stop')"
                                                class="px-2 py-1 bg-red-500 hover:bg-red-600 text-white text-xs rounded" title="Stop service">
                                                ■
                                            </button>
                                            <button onclick="executeAction('{{$host.ID}}', '{{$service.Name}}', 'restart')"
                                                class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded" title="Restart service">
                                                ↻
                                            </button>
                                        {{end}}
                                        {{if eq $service.Monitor 1}}
                                            <button onclick="executeAction('{{$host.ID}}', '{{$service.Name}}', 'unmonitor')"
                                                class="px-2 py-1 bg-gray-500 hover:bg-gray-600 text-white text-xs rounded" title="Disable monitoring">
                                                ⊘
                                            </button>
                                        {{else}}
                                            <button onclick="executeAction('{{$host.ID}}', '{{$service.Name}}', 'monitor')"
                                                class="px-2 py-1 bg-green-500 hover:bg-green-600 text-white text-xs rounded" title="Enable monitoring">
                                                ⊙
                                            </button>
                                        {{end}}
                                    </div>
                                </td>
                            </tr>
                            {{end}}
                        </tbody>
                    </table>
                    {{else}}
                    <p class="text-gray-500 text-center py-4">No services</p>
                    {{end}}

                    <!-- System Metrics Graphs -->
                    {{range $host.Services}}
                    {{if eq .Type 5}}
                    <div class="mt-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">System Metrics</h3>
                            <div class="flex gap-2">
                                <button onclick="changeTimeRange('{{$host.ID}}', '{{.Name}}', '1h')" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm time-btn" data-range="1h">1h</button>
                                <button onclick="changeTimeRange('{{$host.ID}}', '{{.Name}}', '6h')" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm time-btn" data-range="6h">6h</button>
                                <button onclick="changeTimeRange('{{$host.ID}}', '{{.Name}}', '24h')" class="px-3 py-1 bg-blue-600 text-white rounded text-sm time-btn active" data-range="24h">24h</button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-gray-50 p-4 rounded">
                                <h4 class="text-sm font-semibold text-gray-700 mb-2">System Load</h4>
                                <div style="position: relative; height: 200px;">
                                    <canvas id="load-chart-{{$host.ID}}"></canvas>
                                </div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded">
                                <h4 class="text-sm font-semibold text-gray-700 mb-2">CPU Usage</h4>
                                <div style="position: relative; height: 200px;">
                                    <canvas id="cpu-chart-{{$host.ID}}"></canvas>
                                </div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded">
                                <h4 class="text-sm font-semibold text-gray-700 mb-2">Memory Usage</h4>
                                <div style="position: relative; height: 200px;">
                                    <canvas id="memory-chart-{{$host.ID}}"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <script>
                        // Load metrics after DOM is ready
                        if (document.readyState === 'loading') {
                            document.addEventListener('DOMContentLoaded', function() {
                                loadMetrics('{{$host.ID}}', '{{.Name}}', '24h');
                            });
                        } else {
                            loadMetrics('{{$host.ID}}', '{{.Name}}', '24h');
                        }
                    </script>
                    {{end}}
                    {{end}}
                </div>
            </div>
            {{end}}
        {{else}}
            <div class="bg-white rounded-lg shadow-md p-8 text-center">
                <h3 class="text-lg font-medium">No hosts yet</h3>
                <p class="text-gray-500">Waiting for Monit agents...</p>
            </div>
        {{end}}
    </div>

    <script>
    // Global chart instances
    const charts = {};

    // Fetch metrics data and update charts
    async function loadMetrics(hostId, service, range) {
        try {
            const response = await fetch(`/api/metrics?host_id=${hostId}&service=${service}&range=${range}`);
            const data = await response.json();

            if (!data.metrics || data.metrics.length === 0) {
                console.log('No metrics data available');
                return;
            }

            // Group metrics by type
            const metricsByType = {};
            data.metrics.forEach(metric => {
                if (!metricsByType[metric.type]) {
                    metricsByType[metric.type] = {};
                }
                metricsByType[metric.type][metric.name] = metric;
            });

            // Update charts
            updateLoadChart(hostId, metricsByType.load || {});
            updateCPUChart(hostId, metricsByType.cpu || {});
            updateMemoryChart(hostId, metricsByType.memory || {});

        } catch (error) {
            console.error('Failed to load metrics:', error);
        }
    }

    // Update load average chart
    function updateLoadChart(hostId, loadMetrics) {
        const ctx = document.getElementById(`load-chart-${hostId}`);
        if (!ctx) return;

        const avg01 = loadMetrics.avg01 || { timestamps: [], values: [] };
        const avg05 = loadMetrics.avg05 || { timestamps: [], values: [] };
        const avg15 = loadMetrics.avg15 || { timestamps: [], values: [] };

        const chartKey = `load-${hostId}`;
        if (charts[chartKey]) {
            charts[chartKey].destroy();
        }

        charts[chartKey] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: avg01.timestamps.map(t => new Date(t).toLocaleTimeString()),
                datasets: [
                    {
                        label: '1 min',
                        data: avg01.values,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: '5 min',
                        data: avg05.values,
                        borderColor: 'rgb(16, 185, 129)',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: '15 min',
                        data: avg15.values,
                        borderColor: 'rgb(245, 158, 11)',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 2,
                plugins: {
                    legend: { display: true, position: 'top' }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        grace: '10%',
                        title: { display: true, text: 'Load' },
                        ticks: {
                            callback: function(value) {
                                return value.toFixed(2);
                            }
                        }
                    }
                }
            }
        });
    }

    // Update CPU usage chart
    function updateCPUChart(hostId, cpuMetrics) {
        const ctx = document.getElementById(`cpu-chart-${hostId}`);
        if (!ctx) return;

        const user = cpuMetrics.user || { timestamps: [], values: [] };
        const system = cpuMetrics.system || { timestamps: [], values: [] };

        const chartKey = `cpu-${hostId}`;
        if (charts[chartKey]) {
            charts[chartKey].destroy();
        }

        charts[chartKey] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: user.timestamps.map(t => new Date(t).toLocaleTimeString()),
                datasets: [
                    {
                        label: 'User',
                        data: user.values,
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'System',
                        data: system.values,
                        borderColor: 'rgb(168, 85, 247)',
                        backgroundColor: 'rgba(168, 85, 247, 0.1)',
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 2,
                plugins: {
                    legend: { display: true, position: 'top' }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grace: '10%',
                        title: { display: true, text: '%' },
                        ticks: {
                            callback: function(value) {
                                return value.toFixed(1) + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    // Update memory usage chart
    function updateMemoryChart(hostId, memoryMetrics) {
        const ctx = document.getElementById(`memory-chart-${hostId}`);
        if (!ctx) return;

        const percent = memoryMetrics.percent || { timestamps: [], values: [] };

        const chartKey = `memory-${hostId}`;
        if (charts[chartKey]) {
            charts[chartKey].destroy();
        }

        charts[chartKey] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: percent.timestamps.map(t => new Date(t).toLocaleTimeString()),
                datasets: [
                    {
                        label: 'Memory Used',
                        data: percent.values,
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 2,
                plugins: {
                    legend: { display: true, position: 'top' }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grace: '10%',
                        title: { display: true, text: '%' },
                        ticks: {
                            callback: function(value) {
                                return value.toFixed(1) + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    // Change time range
    function changeTimeRange(hostId, service, range) {
        // Update button styles
        document.querySelectorAll('.time-btn').forEach(btn => {
            if (btn.getAttribute('data-range') === range) {
                btn.classList.remove('bg-gray-200');
                btn.classList.add('bg-blue-600', 'text-white');
            } else {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-gray-200');
            }
        });

        // Reload metrics with new range
        loadMetrics(hostId, service, range);
    }

    // Execute action on service
    async function executeAction(hostId, serviceName, action) {
        // Confirm with user
        const actionNames = {
            'start': 'Start',
            'stop': 'Stop',
            'restart': 'Restart',
            'monitor': 'Enable monitoring for',
            'unmonitor': 'Disable monitoring for'
        };

        const actionText = actionNames[action] || action;
        if (!confirm(`${actionText} service '${serviceName}'?`)) {
            return;
        }

        try {
            const response = await fetch('/api/action', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    host_id: hostId,
                    service: serviceName,
                    action: action
                })
            });

            const result = await response.json();

            if (result.success) {
                alert('Success: ' + result.message);
                // Reload page after a short delay to show updated status
                setTimeout(() => window.location.reload(), 2000);
            } else {
                alert('Error: ' + result.message);
            }
        } catch (error) {
            console.error('Failed to execute action:', error);
            alert('Failed to execute action: ' + error.message);
        }
    }

    // Auto-refresh page every 60 seconds
    setInterval(function() {
        window.location.reload();
    }, 60000);
    </script>
</body>
</html>
